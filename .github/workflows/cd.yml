name: CD

permissions:
  contents: none
  packages: read

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

env:
  REGISTRY: ghcr.io
  DEPLOY_ENVIRONMENT: production

jobs:
  deploy:
    name: Deploy ${{ github.event.workflow_run.ref_name }} to ${{ env.DEPLOY_ENVIRONMENT }}
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    environment: ${{ env.DEPLOY_ENVIRONMENT }}

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        env:
          # The tag name from the completed Release workflow run
          RELEASE_VERSION: ${{ github.event.workflow_run.ref_name }}
        with:
          # 从GitHub Secrets中读取服务器连接信息
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22

          # 在远程服务器上执行的脚本
          script: |
            set -e

            echo "Logging into GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u "${{ github.actor }}" --password-stdin

            export ABACUSFLOW_SERVER_VERSION=${{ env.RELEASE_VERSION }}
            export ABACUSFLOW_WEBAPP_VERSION=${{ env.RELEASE_VERSION }}

            # 进入项目部署目录
            cd /opt/abacusflow/abacusflow/

            echo "Starting deployment of version ${{ env.RELEASE_VERSION }} to ${{ env.DEPLOY_ENVIRONMENT }}..."

            if [ "${{ env.DEPLOY_ENVIRONMENT }}" = "production" ]; then
              echo "Using production compose file..."
              docker compose -f docker-compose-prod.yml pull
              docker compose -f docker-compose-prod.yml up -d --remove-orphans
            else
              echo "Error: Unknown environment '${{ env.DEPLOY_ENVIRONMENT }}'"
              exit 1
            fi

            echo "Deployment completed successfully."
